# ASP.NET
# Build and test ASP.NET projects.
# Add steps that publish symbols, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/apps/aspnet/build-aspnet-4

trigger:
  branches:
    include:
      - main
  paths:
    include:
      - MGR.RabbitMQEventBus/*

pool:
  vmImage: "ubuntu-latest"

variables:
  buildConfiguration: "Release"
  PackageName: "MGR.EventBus"
  Projects: "**/*.csproj"
  Tests: "**/*Test*.csproj"
  Packages: $(Projects);!$(Tests)
  Version: 1.0

name: $(Version)$(Rev:.r)

steps:
  - task: UseDotNet@2
    displayName: "Use .Net 5"
    inputs:
      version: "5.0.x"

  - task: DotNetCoreCLI@2
    displayName: "NuGet Restore"
    inputs:
      command: "restore"
      projects: $(Projects)

  - task: DotNetCoreCLI@2
    displayName: "Build $(buildConfiguration)"
    inputs:
      command: "build"
      projects: $(Projects)
      arguments: "--configuration $(buildConfiguration)"

  - task: DotNetCoreCLI@2
    displayName: "Run Unit Tests - $(buildConfiguration)"
    inputs:
      command: "test"
      arguments: "--no-build --configuration $(buildConfiguration)"
      publishTestResults: true
      projects: $(Tests)

  - task: NuGetCommand@2
    displayName: "NuGet Pack"
    inputs:
      command: pack
      packagesToPack: $(Packages)
      packDestination: "$(Build.ArtifactStagingDirectory)"
      versioningScheme: byBuildNumber

  - task: NuGetAuthenticate@0
    displayName: "NuGet Authenticate"

  - task: NuGetCommand@2
    displayName: "NuGet Push"
    inputs:
      command: "push"
      packagesToPush: "$(Build.ArtifactStagingDirectory)/**/*.nupkg"
      nuGetFeedType: "internal"
      publishVstsFeed: "360ba89a-1801-4850-9e40-b49110a639e5"
      allowPackageConflicts: true